<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬æ—…éŠè¨˜å¸³æœ¬</title>
    <!-- å¼•å…¥ Bootstrap CSS ç¾åŒ–ä»‹é¢ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ FontAwesome åœ–ç¤º -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .total-display { font-size: 1.5rem; font-weight: bold; color: #0d6efd; }
        .loading-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center;
        }
        .category-badge { font-size: 0.9rem; }
    </style>
</head>
<body>

<!-- è®€å–å‹•ç•« -->
<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container py-4">
    <h2 class="text-center mb-4"><i class="fas fa-plane-departure"></i> æ—¥æœ¬æ—…éŠè¨˜å¸³æœ¬</h2>

    <!-- ç¸½é‡‘é¡å¡ç‰‡ -->
    <div class="card bg-white p-3 text-center">
        <div class="text-muted">ç¸½æ”¯å‡º (å°å¹£)</div>
        <div class="total-display" id="totalTWD">NT$ 0</div>
    </div>

    <!-- æ–°å¢æ¶ˆè²»è¡¨å–® -->
    <div class="card p-3">
        <h5 class="card-title mb-3">æ–°å¢æ¶ˆè²»</h5>
        <form id="expenseForm">
            <div class="mb-3">
                <label class="form-label">æ—¥æœŸ</label>
                <input type="date" id="date" class="form-control" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label">é …ç›®é¡åˆ¥</label>
                <select id="category" class="form-select" required>
                    <option value="åƒ">ğŸ” åƒ (é¤é£²)</option>
                    <option value="äº¤é€š">Vm äº¤é€š</option>
                    <option value="ä½å®¿">ğŸ¨ ä½å®¿</option>
                    <option value="ç™¼å±•å ´">ğŸ¡ ç™¼å±•å ´ (å¨›æ¨‚/æ™¯é»)</option>
                    <option value="é›œé …">ğŸ›’ é›œé … (è³¼ç‰©/å…¶ä»–)</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">åç¨± / å‚™è¨»</label>
                <input type="text" id="name" class="form-control" placeholder="ä¾‹å¦‚ï¼šä¸€è˜­æ‹‰éºµ" required>
            </div>

            <div class="row mb-3">
                <div class="col-6">
                    <label class="form-label">å¹£åˆ¥</label>
                    <select id="currency" class="form-select">
                        <option value="JPY">ğŸ‡¯ğŸ‡µ æ—¥å¹£ (JPY)</option>
                        <option value="TWD">ğŸ‡¹ğŸ‡¼ å°å¹£ (TWD)</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">é‡‘é¡</label>
                    <input type="number" id="amount" class="form-control" placeholder="0" required step="0.01">
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">åŠ å…¥è¨˜å¸³</button>
            </div>
        </form>
    </div>

    <!-- åŠŸèƒ½æŒ‰éˆ• -->
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-success btn-sm me-2" onclick="exportCSV()"><i class="fas fa-file-csv"></i> åŒ¯å‡º Excel/CSV</button>
        <button class="btn btn-danger btn-sm" onclick="clearAllData()"><i class="fas fa-trash"></i> æ¸…ç©ºè³‡æ–™</button>
    </div>

    <!-- åˆ—è¡¨é¡¯ç¤º -->
    <div id="expenseList">
        <!-- Javascript æœƒå°‡è³‡æ–™æ¸²æŸ“åœ¨é€™è£¡ -->
    </div>
</div>

<!-- JavaScript é‚è¼¯ -->
<script>
    // åˆå§‹åŒ–æ—¥æœŸç‚ºä»Šå¤©
    document.getElementById('date').valueAsDate = new Date();

    // å¾ LocalStorage è®€å–è³‡æ–™
    let expenses = JSON.parse(localStorage.getItem('travelExpenses')) || [];
    renderExpenses();

    // è¡¨å–®æäº¤äº‹ä»¶
    document.getElementById('expenseForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const date = document.getElementById('date').value;
        const category = document.getElementById('category').value;
        const name = document.getElementById('name').value;
        const currency = document.getElementById('currency').value;
        const originalAmount = parseFloat(document.getElementById('amount').value);
        
        if(!date || !name || !originalAmount) return;

        showLoading(true);

        let twdAmount = originalAmount;
        let rate = 1;
        let note = "";

        // å¦‚æœæ˜¯æ—¥å¹£ï¼Œé€²è¡ŒåŒ¯ç‡æ›ç®—
        if (currency === 'JPY') {
            try {
                // åˆ¤æ–·æ—¥æœŸï¼šå¦‚æœæ˜¯ä»Šå¤©æˆ–æœªä¾†ï¼Œä½¿ç”¨æœ€æ–°åŒ¯ç‡ï¼›å¦‚æœæ˜¯éå»ï¼Œä½¿ç”¨æ­·å²åŒ¯ç‡
                const today = new Date().toISOString().split('T')[0];
                let apiUrl = `https://api.frankfurter.app/latest?from=JPY&to=TWD`;
                
                if (date < today) {
                    apiUrl = `https://api.frankfurter.app/${date}?from=JPY&to=TWD`;
                }

                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.rates && data.rates.TWD) {
                    rate = data.rates.TWD;
                    twdAmount = originalAmount * rate;
                    note = `(åŒ¯ç‡ç´„ ${rate.toFixed(4)})`;
                } else {
                    alert("ç„¡æ³•ç²å–è©²æ—¥åŒ¯ç‡ï¼Œå°‡ä»¥ 0.22 æš«ä¼°ï¼Œè«‹ç¨å¾Œæ‰‹å‹•ä¿®æ­£ã€‚");
                    rate = 0.22;
                    twdAmount = originalAmount * rate;
                }
            } catch (error) {
                console.error("åŒ¯ç‡APIéŒ¯èª¤", error);
                alert("åŒ¯ç‡è½‰æ›å¤±æ•— (å¯èƒ½æ˜¯ç¶²è·¯å•é¡Œæˆ–æ—¥æœŸå¤ªä¹…é )ï¼Œå°‡ä»¥ç›®å‰é è¨­å€¼è¨ˆç®—ã€‚");
            }
        }

        const newExpense = {
            id: Date.now(),
            date,
            category,
            name,
            currency,
            originalAmount,
            twdAmount,
            rate
        };

        expenses.unshift(newExpense); // åŠ åˆ°æœ€å‰é¢
        saveAndRender();
        
        // é‡ç½®è¡¨å–®éƒ¨åˆ†æ¬„ä½
        document.getElementById('name').value = '';
        document.getElementById('amount').value = '';
        showLoading(false);
    });

    // åˆªé™¤å–®ç­†
    function deleteExpense(id) {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
            expenses = expenses.filter(item => item.id !== id);
            saveAndRender();
        }
    }

    // å„²å­˜ä¸¦æ¸²æŸ“
    function saveAndRender() {
        localStorage.setItem('travelExpenses', JSON.stringify(expenses));
        renderExpenses();
    }

    // æ¸²æŸ“ç•«é¢
    function renderExpenses() {
        const listContainer = document.getElementById('expenseList');
        listContainer.innerHTML = '';
        
        let total = 0;

        expenses.forEach(item => {
            total += item.twdAmount;
            
            const isJPY = item.currency === 'JPY';
            const amountDisplay = isJPY 
                ? `Â¥${item.originalAmount.toLocaleString()} <small class="text-muted">â‰ˆ NT$${Math.round(item.twdAmount).toLocaleString()}</small>`
                : `NT$${item.originalAmount.toLocaleString()}`;

            const badgeColor = {
                'ä½å®¿': 'bg-info',
                'äº¤é€š': 'bg-warning text-dark',
                'åƒ': 'bg-success',
                'ç™¼å±•å ´': 'bg-danger',
                'é›œé …': 'bg-secondary'
            }[item.category] || 'bg-primary';

            const card = document.createElement('div');
            card.className = 'card p-3';
            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge ${badgeColor} category-badge mb-1">${item.category}</span>
                        <div class="fw-bold fs-5">${item.name}</div>
                        <div class="text-muted small">
                            <i class="far fa-calendar-alt"></i> ${item.date} 
                            ${isJPY ? `<span class="ms-2 badge bg-light text-dark border">åŒ¯ç‡ ${item.rate.toFixed(4)}</span>` : ''}
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-primary">${amountDisplay}</div>
                        <button class="btn btn-outline-danger btn-sm mt-2" onclick="deleteExpense(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            listContainer.appendChild(card);
        });

        document.getElementById('totalTWD').innerText = `NT$ ${Math.round(total).toLocaleString()}`;
    }

    // åŒ¯å‡º CSV
    function exportCSV() {
        if(expenses.length === 0) {
            alert("æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼");
            return;
        }
        let csvContent = "\uFEFFæ—¥æœŸ,é¡åˆ¥,åç¨±,åŸå¹£é‡‘é¡,å¹£åˆ¥,åŒ¯ç‡,å°å¹£é‡‘é¡\n";
        expenses.forEach(e => {
            csvContent += `${e.date},${e.category},${e.name},${e.originalAmount},${e.currency},${e.rate},${e.twdAmount}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `æ—¥æœ¬æ—…éŠè¨˜å¸³_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // æ¸…ç©ºæ‰€æœ‰è³‡æ–™
    function clearAllData() {
        if(confirm("è­¦å‘Šï¼šé€™å°‡æœƒåˆªé™¤æ‰‹æ©Ÿå…§æ‰€æœ‰çš„è¨˜å¸³è³‡æ–™ä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šå—ï¼Ÿ")) {
            expenses = [];
            saveAndRender();
        }
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>